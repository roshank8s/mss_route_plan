<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <record id="view_traktop_products_list" model="ir.ui.view">
    <field name="name">route.planing.products.list</field>
    <field name="model">stock.move</field>
    <field name="arch" type="xml">
        <list string="Order Products"
            create="false"
            delete="false"
            editable="bottom"
            js_class="no_selector_tree"
            class ="products">
        <field name="product_id" readonly="1"/>
        <field name="product_uom_qty" string="Quantity" readonly="1"/>
        <field name="picked"/>
        </list>
    </field>
    </record>

    <!-- 2) Action to open that list in the current window -->
    <record id="action_traktop_products" model="ir.actions.act_window">
      <field name="name">Order Products</field>
      <field name="res_model">stock.move</field>
      <!-- Use your custom list as the primary view -->
      <field name="view_mode">list,form</field>
      <field name="view_id" ref="view_traktop_products_list"/>
      <field name="target">current</field>
      <field name="domain">[]</field>
      <field name="help" type="html">
        <p class="o_view_nocontent_smiling_face">
          There are no products on this delivery yet.
        </p>
      </field>
    </record>
    <record id="action_optimized_rec_created" model="ir.actions.server">
      <field name="name">Optimize Records</field>
      <field name="model_id" ref="model_route_planing"/>
      <field name="binding_model_id" ref="model_route_planing"/>
      <field name="state">code</field>
      <field name="binding_type">action</field> 
      <field name="code">
        action = model.get_optimized_rec_created()
      </field>
    </record>

    <!-- 3) Route Planing: List view with “View” and “Products” buttons -->
    <record id="view_traktop_list" model="ir.ui.view">
      <field name="name">route.planing.list</field>
      <field name="model">route.planing</field>
      <field name="arch" type="xml">
        <list  js_class="group_sortable_list" editable="bottom" create="false" delete="1" multi_edit="1" class = "delivery-orders" >
          <header>
            <button
            name="%(action_optimized_rec_created)d"
            type="action"
            string="Optimize"
            class="oe_highlight"
            icon="fa-cogs"
            groups="base.group_system"
          />
          </header>
           <field name="sequence" widget="handle" string="Move"/>
          <field name="delivery_order_id" widget="many2one_button"/>
          <field name="partner_id"/>
          <field name="delivery_address"/>
          <!-- <field name="vehicle_starting_point" /> -->
          <field name="vehicle_id"/>
          <field name="delivery_date" widget="datetime" string="Delivery Date"/>
          <field name="manual_vehicle_override" widget="boolean_toggle"/>
          <field name="driver_name"/>
          <!-- <field name="product_summary" readonly="1" />  -->
          <!-- <button name="move_up" type="object" icon="fa-arrow-up"/>
          <button name="move_down" type="object" icon="fa-arrow-down"/> -->
          <!-- <button name="action_view_products"  type="object" string="Products" icon="fa-list"/>       -->
        </list>
      </field>
    </record>
    
    <!-- 4) Route Planing: Form view with header buttons -->
    <record id="view_traktop_form" model="ir.ui.view">
      <field name="name">route.planing.form</field>
      <field name="model">route.planing</field>
      <field name="arch" type="xml">
        <form string="Route Planing">
         <!-- <header>
             <button name="action_view_delivery_order"
                    type="object"
                    string="View Order"
                    class="oe_highlight"/>
            <button name="action_view_products"
                    type="object"
                    string="Products"
                    class="oe_stat_button"
                    icon="fa-list"/> 
          </header> -->
          <sheet>
            <group>
              <field name="delivery_order_id"/>
              <field name="partner_id"/>
              <field name="delivery_address"/>
            </group>
            <group>
              <field name="delivery_date"/>
              <field name="partner_latitude"/>
              <field name="partner_longitude"/>
            </group>
            <group>
              <field name="vehicle_id"/>
              <!-- <field name="vehicle_starting_point"/> -->
              <field name="manual_vehicle_override" />
              <!-- <field name="driver_name"/> -->
            </group>
            <group>
              <field name="route_id"/>
              <field name="route_sequence"/>
              <field name="step_type"/>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <!-- 5) Route Planing: Search view -->
    <record id="view_traktop_search" model="ir.ui.view">
      <field name="name">route.planing.search</field>
      <field name="model">route.planing</field>
      <field name="arch" type="xml">
        <search string="Route Planing">
          <field name="delivery_order_id"/>
          <field name="partner_id"/>
          <separator/>
          <filter string="Upcoming"
                  name="filter_delivery_date_ge_today"
                  domain="[('delivery_date','>=', context_today())]"
                  date="delivery_date"/>
          <group expand="0" string="Group By">
            <filter string="By Delivery Date"
                    name="group_by_delivery_date"
                    context="{'group_by':'delivery_date'}"/>
            <filter string="By Customer"
                    name="group_by_partner_id"
                    context="{'group_by':'partner_id'}"/>
            <filter string="By Vehicle"
                    name="group_by_vehicle_id"
                    context="{'group_by':'vehicle_id'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- 6) Route Planing: Detail Map View -->
    <record id="traktop_map_view" model="ir.ui.view">
      <field name="name">route.planing.map.view</field>
      <field name="model">route.planing</field>
      <field name="arch" type="xml">
        <form string="Route Planing Map View">
          <sheet>
            <group>
              <field name="partner_id"/>
              <field name="delivery_order_id"/>
              <field name="display_name" widget="html" readonly="1"/>
              <field name="vehicle_id" widget="selection"/>
            </group>
            <notebook>
              <page string="Delivery Orders">
                <list>
                  <field name="delivery_order_id"/>
                  <field name="partner_id"/>
                  <field name="vehicle_id"/>
                </list>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <!-- 7) Route Planing: Multiple‑Markers Map View -->
    <record id="view_traktop_multiple_markers_form" model="ir.ui.view">
      <field name="name">route.planing.map.multiple.markers</field>
      <field name="model">route.planing</field>
      <field name="arch" type="xml">
        <form string="Map View"
              create="false"
              edit="false"
              delete="false"
              readonly="1"
              class="hide-on-form">
          <sheet>
            <group>
              <field name="partner_latitude"
                     widget="address_multiple_markers_gmap"
                     readonly="1"
                     nolabel="1"/>
              <field name="partner_longitude" invisible="1"/>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <record id="action_traktop" model="ir.actions.act_window">
      <field name="name">Delivery Orders</field>
      <field name="res_model">route.planing</field>
      <field name="view_mode">list,form</field>
      <field name="domain">[('delivery_order_id','!=',False)]</field>
      <field name="context">{'search_default_group_by_vehicle_id':1}</field>
    </record>

    <record id="action_traktop_map" model="ir.actions.act_window">
      <field name="name">Route Planing Map</field>
      <field name="res_model">route.planing</field>
      <field name="view_mode">form</field>
      <field name="view_id" ref="traktop_map_view"/>
      <field name="context">{'default_vehicle_id': active_id}</field>
    </record>

    <record id="action_traktop_multiple_markers" model="ir.actions.act_window">
      <field name="name">Map</field>
      <field name="res_model">route.planing</field>
      <field name="view_mode">form</field>
      <field name="view_id" ref="view_traktop_multiple_markers_form"/>
      <field name="target">current</field>
    </record>

    <record id="action_optimized_rec_created" model="ir.actions.server">
      <field name="name">Optimize Records</field>
      <field name="model_id" ref="model_route_planing"/>
      <field name="binding_model_id" ref="model_route_planing"/>
      <field name="state">code</field>
      <field name="binding_type">action</field> 
      <field name="code">
        action = model.get_optimized_rec_created()
      </field>
    </record>

    <!-- 9) Route Planing: Menu Items -->
    <menuitem id="traktop_main_menu"
              name="Route Planing"
              sequence="10"
              web_icon="mss_route_plan,static/description/icon.png"/>
    <menuitem id="traktop_menu"
              name="Delivery Orders"
              action="action_traktop"
              parent="traktop_main_menu"/>
    <menuitem id="menu_traktop_multiple_markers"
              name="Map View"
              action="action_traktop_multiple_markers"
              parent="traktop_main_menu"
              sequence="20"/>
  </data>
</odoo>
